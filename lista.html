<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IFCLABS - Plataforma Colaborativa</title>
    <link rel="stylesheet" href="style.css">
    
    <!-- Estilos para o novo sistema de mudan√ßas em lote -->
    <style>
        /* === ESTILOS PARA SISTEMA DE MUDAN√áAS EM LOTE === */
        
        /* Indicador visual de mudan√ßas n√£o salvas */
        .unsaved-changes-indicator {
            position: fixed;
            top: 80px;
            right: 20px;
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
            color: #212529;
            padding: 0.75rem 1rem;
            border-radius: 25px;
            font-weight: 600;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3);
            transform: translateX(300px);
            transition: transform 0.3s ease;
        }
        
        .unsaved-changes-indicator.show {
            transform: translateX(0);
        }
        
        /* C√©lula modificada */
        .cell-modified {
            background: linear-gradient(135deg, #e7f3ff 0%, #b3d7ff 100%) !important;
            border-left: 3px solid #007bff;
            position: relative;
        }
        
        .cell-modified::after {
            content: 'üìù';
            position: absolute;
            top: 2px;
            right: 4px;
            font-size: 10px;
        }
        
        /* Linha nova */
        .row-added {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%) !important;
        }
        
        .row-added::before {
            content: 'üÜï';
            position: absolute;
            left: -20px;
            top: 50%;
            transform: translateY(-50%);
        }
        
        /* Modal de Revis√£o de Mudan√ßas */
        .changes-review-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            z-index: 2000;
        }
        
        .changes-review-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .changes-review-content {
            background: white;
            border-radius: 12px;
            width: 95%;
            max-width: 1000px;
            max-height: 95vh;  /* Garante que nunca exceda a altura da tela */
            display: flex;
            flex-direction: column;  /* Layout em coluna para controle de altura */
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            animation: modalSlideIn 0.4s ease-out;
        }
        
        @keyframes modalSlideIn {
            from { opacity: 0; transform: scale(0.8) translateY(50px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
        
        .changes-review-header {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            padding: 1.5rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .changes-review-header h3 {
            margin: 0;
            font-size: 1.4em;
        }
        
        .changes-count {
            background: rgba(255,255,255,0.2);
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.9em;
        }
        
        .changes-review-body {
            padding: 0;
            max-height: 50vh;  /* Reduzido para deixar espa√ßo para footer */
            overflow-y: auto;
            overflow-x: hidden;
            /* Adiciona indicadores visuais de scroll */
            scrollbar-width: thin;
            scrollbar-color: #007bff #f1f3f5;
        }
        
        /* Estiliza√ß√£o personalizada da barra de rolagem para WebKit browsers */
        .changes-review-body::-webkit-scrollbar {
            width: 8px;
        }
        
        .changes-review-body::-webkit-scrollbar-track {
            background: #f1f3f5;
            border-radius: 4px;
        }
        
        .changes-review-body::-webkit-scrollbar-thumb {
            background: #007bff;
            border-radius: 4px;
        }
        
        .changes-review-body::-webkit-scrollbar-thumb:hover {
            background: #0056b3;
        }
        
        .changes-summary {
            padding: 1.5rem 2rem;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }
        
        .changes-list {
            padding: 0;
        }
        
        .change-item {
            border-bottom: 1px solid #e9ecef;
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: background 0.2s;
        }
        
        .change-item:hover {
            background: #f8f9fa;
        }
        
        .change-item:last-child {
            border-bottom: none;
        }
        
        .change-icon {
            font-size: 1.2em;
            width: 30px;
            text-align: center;
        }
        
        .change-details {
            flex-grow: 1;
        }
        
        .change-location {
            font-weight: 600;
            color: #495057;
            margin-bottom: 0.25rem;
        }
        
        .change-description {
            font-size: 0.9em;
            color: #6c757d;
        }
        
        .change-values {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.25rem;
        }
        
        .old-value, .new-value {
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.85em;
        }
        
        .old-value {
            background: #f8d7da;
            color: #721c24;
            text-decoration: line-through;
        }
        
        .new-value {
            background: #d4edda;
            color: #155724;
            font-weight: 600;
        }
        
        .change-comment-section {
            margin-top: 0.5rem;
        }
        
        .change-comment-input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            font-size: 0.9em;
            resize: vertical;
            min-height: 60px;
        }
        
        .change-comment-input:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
            outline: none;
        }
        
        .comment-toggle {
            background: none;
            border: none;
            color: #007bff;
            cursor: pointer;
            font-size: 0.85em;
            text-decoration: underline;
        }
        
        .comment-toggle:hover {
            color: #0056b3;
        }
        
        /* Se√ß√£o de coment√°rio geral */
        .general-comment-section {
            padding: 1.5rem 2rem;
            border-top: 2px solid #007bff;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }
        
        .general-comment-section h4 {
            color: #007bff;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .general-comment-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-family: inherit;
            resize: vertical;
            min-height: 80px;
        }
        
        .general-comment-input:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
            outline: none;
        }
        
        /* Footer do modal */
        .changes-review-footer {
            padding: 1.5rem 2rem;
            background: #f8f9fa;
            border-top: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .changes-stats {
            font-size: 0.9em;
            color: #6c757d;
        }
        
        .footer-actions {
            display: flex;
            gap: 1rem;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.9em;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #545b62;
            transform: translateY(-1px);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,123,255,0.3);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #218838 100%);
            color: white;
        }
        
        .btn-success:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(40,167,69,0.3);
        }
        
        /* Melhorias no bot√£o de salvar */
        #save-changes-button {
            background: linear-gradient(135deg, #28a745 0%, #218838 100%);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }
        
        #save-changes-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(40,167,69,0.4);
        }
        
        #save-changes-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .changes-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ffc107;
            color: #212529;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.7em;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        /* Notifica√ß√µes aprimoradas */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 3000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            max-width: 350px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success {
            background: linear-gradient(135deg, #28a745 0%, #218838 100%);
        }
        
        .notification.info {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
        }
        
        .notification.warning {
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
            color: #212529;
        }
    </style>
</head>
<body>
    <header>
        <h1>Plataforma Colaborativa IFCLABS</h1>
        <div id="user-info">
            <span id="user-greeting"></span>
            <button id="logout-button" style="display: none;">Sair</button>
        </div>
    </header>

    <main>
        <!-- SE√á√ÉO EXISTENTE: Seletor de Projetos (mantida igual) -->
        <section id="project-selector">
            <h2>Meus Projetos</h2>
            <div id="project-list">
                <p>Carregando projetos...</p>
            </div>
        </section>

        <!-- SE√á√ÉO EXISTENTE: Visualizador de Documentos (mantida) -->
        <section id="document-viewer" style="display: none;">
            <h2 id="document-title"></h2>
            
            <div id="document-metadata">
                <h4>Detalhes do Documento</h4>
                <p><strong>Criado por:</strong> <span id="meta-created-by"></span></p>
                <p><strong>Em:</strong> <span id="meta-created-at"></span></p>
                <p><strong>√öltima Modifica√ß√£o:</strong> <span id="meta-last-modified-by"></span> √†s <span id="meta-last-modified-at"></span></p>
                <div id="document-general-comments">
                    <h5>Coment√°rios Gerais do Documento:</h5>
                    <ul id="doc-comments-list"></ul>
                </div>
            </div>

            <nav id="tab-navigation">
                <h3>Abas do Documento</h3>
                <div id="tab-buttons">
                    <!-- Bot√µes das abas ser√£o inseridos aqui -->
                </div>
            </nav>

            <article id="tab-content-area">
                <h3 id="current-tab-name"></h3>
                
                <div class="controls-container" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #eee;">
                    <div id="tab-action-buttons-placeholder">
                        <!-- Bot√µes de a√ß√£o da aba ser√£o inseridos aqui -->
                    </div>
                    <div id="save-button-container">
                        <!-- Bot√£o de Salvar ser√° inserido aqui -->
                    </div>
                </div>

                <div id="data-table-container">
                    <!-- Tabela de dados da aba ser√° inserida aqui -->
                </div>
            </article>
        </section>
    </main>

    <!-- Indicador de mudan√ßas n√£o salvas -->
    <div id="unsaved-changes-indicator" class="unsaved-changes-indicator">
        <span id="changes-count">0 mudan√ßas</span> n√£o salvas
    </div>

    <!-- Modal de Revis√£o de Mudan√ßas -->
    <div class="changes-review-modal" id="changes-review-modal">
        <div class="changes-review-content">
            <div class="changes-review-header">
                <h3>üìã Revisar Mudan√ßas</h3>
                <div class="changes-count" id="modal-changes-count">0 mudan√ßas</div>
                <button class="btn btn-secondary" onclick="closeChangesReview()">‚úï</button>
            </div>
            
            <div class="changes-review-body">
                <div class="changes-summary">
                    <p><strong>Resumo:</strong> <span id="changes-summary-text">Nenhuma mudan√ßa detectada</span></p>
                </div>
                
                <div class="changes-list" id="changes-list">
                    <!-- Lista de mudan√ßas ser√° inserida aqui -->
                </div>
            </div>
            
            <div class="general-comment-section">
                <h4>üí¨ Coment√°rio Geral (Opcional)</h4>
                <textarea 
                    id="general-comment-input" 
                    class="general-comment-input"
                    placeholder="Descreva o prop√≥sito geral das mudan√ßas realizadas... Ex: 'Atualiza√ß√£o conforme nova especifica√ß√£o t√©cnica do cliente'"
                ></textarea>
            </div>
            
            <div class="changes-review-footer">
                <div class="changes-stats">
                    <span id="stats-text">Preparado para salvar</span>
                </div>
                <div class="footer-actions">
                    <button class="btn btn-secondary" onclick="closeChangesReview()">Cancelar</button>
                    <button class="btn btn-primary" onclick="saveDraftChanges()">Salvar como Rascunho</button>
                    <button class="btn btn-success" onclick="submitChanges()">üíæ Salvar e Enviar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Container para notifica√ß√µes -->
    <div id="notifications-container"></div>

    <footer>
        <p>&copy; 2025 IFCLABS. MVP.</p>
    </footer>

    <!-- SCRIPTS EXISTENTES (mantidos) -->
    <script src="script.js"></script>
    
    <!-- NOVO: Sistema de Rastreamento de Mudan√ßas -->
    <script>
        // === SISTEMA DE RASTREAMENTO DE MUDAN√áAS EM BACKGROUND ===
        
        // Estado global do sistema
        let changeTracker = {
            originalData: new Map(), // Estado original de cada c√©lula
            changes: new Map(),      // Mudan√ßas realizadas
            isTracking: false,       // Se est√° rastreando mudan√ßas
            currentUser: sessionStorage.getItem('ifclabsUser') || "usuario@exemplo.com"
        };
        
        // Tipos de mudan√ßas poss√≠veis
        const CHANGE_TYPES = {
            CELL_EDIT: 'cell_edit',
            ROW_ADD: 'row_add',
            ROW_DELETE: 'row_delete'
        };
        
        // === INICIALIZA√á√ÉO DO SISTEMA ===
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Inicializando sistema de rastreamento de mudan√ßas...');
            
            // Espera o script.js carregar, ent√£o inicializa nosso sistema
            setTimeout(initializeChangeTracking, 1500);
        });
        
        function initializeChangeTracking() {
            console.log('Sistema de rastreamento de mudan√ßas ativo');
            
            // Observer para detectar quando novas tabelas s√£o carregadas
            const tableObserver = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'childList') {
                        const addedNodes = Array.from(mutation.addedNodes);
                        addedNodes.forEach(node => {
                            if (node.nodeType === Node.ELEMENT_NODE) {
                                if (node.tagName === 'TABLE' || node.querySelector('table')) {
                                    setTimeout(() => {
                                        startTrackingTable(node.tagName === 'TABLE' ? node : node.querySelector('table'));
                                    }, 500);
                                }
                            }
                        });
                    }
                });
            });
            
            // Observa mudan√ßas no container da tabela
            const tableContainer = document.getElementById('data-table-container');
            if (tableContainer) {
                tableObserver.observe(tableContainer, { childList: true, subtree: true });
                
                // Tamb√©m tenta inicializar tabela que j√° existe
                const existingTable = tableContainer.querySelector('table');
                if (existingTable) {
                    startTrackingTable(existingTable);
                }
            }
            
            // Atualiza bot√£o de salvar periodicamente
            setInterval(updateSaveButton, 1000);
        }
        
        // === RASTREAMENTO DE TABELA ===
        function startTrackingTable(table) {
            if (!table) return;
            
            console.log('Iniciando rastreamento da tabela');
            changeTracker.isTracking = true;
            
            // Captura estado inicial de todas as c√©lulas
            captureTableSnapshot(table);
            
            // Adiciona listeners para c√©lulas edit√°veis
            addTableListeners(table);
            
            // Atualiza interface
            updateChangeIndicators();
            
            showNotification('Sistema de rastreamento ativo - Trabalhe normalmente!', 'info');
        }
        
        function captureTableSnapshot(table) {
            const rows = table.querySelectorAll('tbody tr');
            
            rows.forEach((row, rowIndex) => {
                const cells = row.querySelectorAll('td[contenteditable="true"]');
                
                cells.forEach((cell, cellIndex) => {
                    const cellKey = getCellKey(cell);
                    changeTracker.originalData.set(cellKey, {
                        value: cell.textContent.trim(),
                        element: cell,
                        rowIndex: rowIndex,
                        cellIndex: cellIndex,
                        timestamp: Date.now()
                    });
                });
            });
            
            console.log(`Capturado snapshot de ${changeTracker.originalData.size} c√©lulas`);
        }
        
        function addTableListeners(table) {
            // Listener para mudan√ßas em c√©lulas
            table.addEventListener('input', handleCellChange);
            table.addEventListener('blur', handleCellBlur, true);
            
            // Observer para novas linhas
            const tableBody = table.querySelector('tbody');
            if (tableBody) {
                const rowObserver = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                        if (mutation.type === 'childList') {
                            mutation.addedNodes.forEach(node => {
                                if (node.nodeType === Node.ELEMENT_NODE && node.tagName === 'TR') {
                                    handleRowAdd(node);
                                }
                            });
                        }
                    });
                });
                
                rowObserver.observe(tableBody, { childList: true });
            }
        }
        
        // === HANDLERS DE MUDAN√áAS ===
        function handleCellChange(event) {
            const cell = event.target;
            if (!cell.hasAttribute('contenteditable')) return;
            
            // Auto check-out se necess√°rio (silencioso)
            silentCheckoutCell(cell);
        }
        
        function handleCellBlur(event) {
            const cell = event.target;
            if (!cell.hasAttribute('contenteditable')) return;
            
            const cellKey = getCellKey(cell);
            const currentValue = cell.textContent.trim();
            const originalData = changeTracker.originalData.get(cellKey);
            
            if (originalData && originalData.value !== currentValue) {
                // Registra mudan√ßa
                registerChange(cellKey, {
                    type: CHANGE_TYPES.CELL_EDIT,
                    cellKey: cellKey,
                    location: getCellLocation(cell),
                    oldValue: originalData.value,
                    newValue: currentValue,
                    timestamp: Date.now(),
                    element: cell
                });
                
                // Adiciona classe visual
                cell.classList.add('cell-modified');
                
                console.log(`Mudan√ßa registrada: ${cellKey} "${originalData.value}" ‚Üí "${currentValue}"`);
            }
            
            updateChangeIndicators();
        }
        
        function handleRowAdd(row) {
            const rowKey = `row-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`;
            
            registerChange(rowKey, {
                type: CHANGE_TYPES.ROW_ADD,
                rowKey: rowKey,
                location: `Nova linha adicionada`,
                element: row,
                timestamp: Date.now()
            });
            
            // Adiciona classe visual
            row.classList.add('row-added');
            
            // Captura c√©lulas da nova linha para tracking futuro
            const cells = row.querySelectorAll('td[contenteditable="true"]');
            cells.forEach(cell => {
                const cellKey = getCellKey(cell);
                changeTracker.originalData.set(cellKey, {
                    value: cell.textContent.trim(),
                    element: cell,
                    timestamp: Date.now(),
                    isNew: true
                });
            });
            
            updateChangeIndicators();
            
            console.log(`Nova linha adicionada: ${rowKey}`);
        }
        
        // === REGISTRO E GERENCIAMENTO DE MUDAN√áAS ===
        function registerChange(changeKey, changeData) {
            changeTracker.changes.set(changeKey, changeData);
            updateChangeIndicators();
        }
        
        function updateChangeIndicators() {
            const changesCount = changeTracker.changes.size;
            const indicator = document.getElementById('unsaved-changes-indicator');
            const countSpan = document.getElementById('changes-count');
            
            if (changesCount > 0) {
                countSpan.textContent = `${changesCount} mudan√ßa${changesCount > 1 ? 's' : ''}`;
                indicator.classList.add('show');
            } else {
                indicator.classList.remove('show');
            }
            
            updateSaveButton();
        }
        
        function updateSaveButton() {
            const saveButton = document.getElementById('save-changes-button');
            if (!saveButton) return;
            
            const changesCount = changeTracker.changes.size;
            
            if (changesCount > 0) {
                saveButton.disabled = false;
                saveButton.innerHTML = `üíæ Salvar Altera√ß√µes`;
                
                // Adiciona badge com n√∫mero de mudan√ßas
                let badge = saveButton.querySelector('.changes-badge');
                if (!badge) {
                    badge = document.createElement('span');
                    badge.className = 'changes-badge';
                    saveButton.appendChild(badge);
                }
                badge.textContent = changesCount;
                
            } else {
                saveButton.disabled = true;
                saveButton.innerHTML = `üíæ Nenhuma altera√ß√£o`;
                const badge = saveButton.querySelector('.changes-badge');
                if (badge) {
                    badge.remove();
                }
            }
        }
        
        // === CHECK-OUT SILENCIOSO ===
        function silentCheckoutCell(cell) {
            const cellKey = getCellKey(cell);
            
            // Em uma implementa√ß√£o real, aqui faria o check-out via API
            // Por enquanto, apenas simula
            console.log(`Auto check-out silencioso: ${cellKey}`);
            
            // Adiciona indicador visual sutil
            cell.style.outline = '1px solid rgba(0,123,255,0.3)';
            
            setTimeout(() => {
                if (cell.style.outline) {
                    cell.style.outline = '';
                }
            }, 2000);
        }
        
        // === MODAL DE REVIS√ÉO DE MUDAN√áAS ===
        function openChangesReview() {
            const modal = document.getElementById('changes-review-modal');
            const changesCount = changeTracker.changes.size;
            
            if (changesCount === 0) {
                showNotification('Nenhuma mudan√ßa para revisar', 'warning');
                return;
            }
            
            // Atualiza contador no modal
            document.getElementById('modal-changes-count').textContent = 
                `${changesCount} mudan√ßa${changesCount > 1 ? 's' : ''}`;
            
            // Atualiza resumo
            document.getElementById('changes-summary-text').textContent = 
                generateChangesSummary();
            
            // Popula lista de mudan√ßas
            populateChangesList();
            
            // Mostra modal
            modal.classList.add('active');
            
            console.log(`Modal de revis√£o aberto com ${changesCount} mudan√ßas`);
        }
        
        function closeChangesReview() {
            const modal = document.getElementById('changes-review-modal');
            modal.classList.remove('active');
            
            // Limpa coment√°rio geral
            document.getElementById('general-comment-input').value = '';
        }
        
        function generateChangesSummary() {
            const changes = Array.from(changeTracker.changes.values());
            const cellEdits = changes.filter(c => c.type === CHANGE_TYPES.CELL_EDIT).length;
            const rowAdds = changes.filter(c => c.type === CHANGE_TYPES.ROW_ADD).length;
            
            let summary = [];
            if (cellEdits > 0) summary.push(`${cellEdits} c√©lula${cellEdits > 1 ? 's editadas' : ' editada'}`);
            if (rowAdds > 0) summary.push(`${rowAdds} linha${rowAdds > 1 ? 's adicionadas' : ' adicionada'}`);
            
            return summary.join(', ') || 'Nenhuma mudan√ßa';
        }
        
        function populateChangesList() {
            const container = document.getElementById('changes-list');
            container.innerHTML = '';
            
            Array.from(changeTracker.changes.entries()).forEach(([changeKey, change]) => {
                const changeItem = createChangeItem(changeKey, change);
                container.appendChild(changeItem);
            });
        }
        
        function createChangeItem(changeKey, change) {
            const item = document.createElement('div');
            item.className = 'change-item';
            
            const icon = getChangeIcon(change.type);
            const location = change.location || 'Local n√£o especificado';
            
            if (change.type === CHANGE_TYPES.CELL_EDIT) {
                item.innerHTML = `
                    <div class="change-icon">${icon}</div>
                    <div class="change-details">
                        <div class="change-location">${location}</div>
                        <div class="change-description">Valor da c√©lula modificado</div>
                        <div class="change-values">
                            <span class="old-value">${change.oldValue || '(vazio)'}</span>
                            <span>‚Üí</span>
                            <span class="new-value">${change.newValue || '(vazio)'}</span>
                        </div>
                        <div class="change-comment-section" style="display: none;">
                            <textarea 
                                class="change-comment-input" 
                                placeholder="Coment√°rio espec√≠fico sobre esta mudan√ßa (opcional)..."
                                data-change-key="${changeKey}"
                            ></textarea>
                        </div>
                    </div>
                    <button class="comment-toggle" onclick="toggleChangeComment(this)">
                        üí¨ Comentar
                    </button>
                `;
            } else if (change.type === CHANGE_TYPES.ROW_ADD) {
                item.innerHTML = `
                    <div class="change-icon">${icon}</div>
                    <div class="change-details">
                        <div class="change-location">${location}</div>
                        <div class="change-description">Nova linha adicionada ao documento</div>
                        <div class="change-comment-section" style="display: none;">
                            <textarea 
                                class="change-comment-input" 
                                placeholder="Coment√°rio sobre a nova linha (opcional)..."
                                data-change-key="${changeKey}"
                            ></textarea>
                        </div>
                    </div>
                    <button class="comment-toggle" onclick="toggleChangeComment(this)">
                        üí¨ Comentar
                    </button>
                `;
            }
            
            return item;
        }
        
        function toggleChangeComment(button) {
            const changeItem = button.closest('.change-item');
            const commentSection = changeItem.querySelector('.change-comment-section');
            
            if (commentSection.style.display === 'none') {
                commentSection.style.display = 'block';
                button.textContent = '‚ùå Cancelar';
                commentSection.querySelector('textarea').focus();
            } else {
                commentSection.style.display = 'none';
                button.textContent = 'üí¨ Comentar';
            }
        }
        
        // === SALVAMENTO ===
        function saveDraftChanges() {
            console.log('Salvando como rascunho...');
            showNotification('Rascunho salvo localmente', 'success');
            closeChangesReview();
        }
        
        function submitChanges() {
            const generalComment = document.getElementById('general-comment-input').value.trim();
            const individualComments = collectIndividualComments();
            
            // Prepara dados para envio
            const submissionData = {
                user: changeTracker.currentUser,
                timestamp: Date.now(),
                generalComment: generalComment,
                changes: Array.from(changeTracker.changes.entries()).map(([key, change]) => ({
                    key: key,
                    ...change,
                    individualComment: individualComments[key] || null
                }))
            };
            
            console.log('Dados preparados para submiss√£o:', submissionData);
            
            // Simula envio (em produ√ß√£o seria uma API call)
            setTimeout(() => {
                showNotification(`${changeTracker.changes.size} mudan√ßas enviadas com sucesso!`, 'success');
                
                // Limpa estado
                clearAllChanges();
                closeChangesReview();
                
                setTimeout(() => {
                    showNotification('Revisores da IFCLABS foram notificados', 'info');
                }, 1500);
            }, 1000);
        }
        
        function collectIndividualComments() {
            const comments = {};
            const commentInputs = document.querySelectorAll('.change-comment-input');
            
            commentInputs.forEach(input => {
                const changeKey = input.dataset.changeKey;
                const comment = input.value.trim();
                if (comment) {
                    comments[changeKey] = comment;
                }
            });
            
            return comments;
        }
        
        function clearAllChanges() {
            // Remove classes visuais
            document.querySelectorAll('.cell-modified').forEach(cell => {
                cell.classList.remove('cell-modified');
            });
            
            document.querySelectorAll('.row-added').forEach(row => {
                row.classList.remove('row-added');
            });
            
            // Limpa estado
            changeTracker.changes.clear();
            
            // Atualiza interface
            updateChangeIndicators();
        }
        
        // === FUN√á√ïES UTILIT√ÅRIAS ===
        function getCellKey(cell) {
            const row = cell.parentElement;
            const rowId = row.getAttribute('data-row-id') || `row-${Array.from(row.parentElement.children).indexOf(row)}`;
            const columnIndex = Array.from(row.children).indexOf(cell);
            const table = cell.closest('table');
            const headerRow = table.querySelector('thead tr');
            const columnName = headerRow ? headerRow.children[columnIndex]?.textContent.trim() : `col-${columnIndex}`;
            
            return `${rowId}_${columnName}`;
        }
        
        function getCellLocation(cell) {
            const row = cell.parentElement;
            const rowId = row.getAttribute('data-row-id') || `Linha ${Array.from(row.parentElement.children).indexOf(row) + 1}`;
            const columnIndex = Array.from(row.children).indexOf(cell);
            const table = cell.closest('table');
            const headerRow = table.querySelector('thead tr');
            const columnName = headerRow ? headerRow.children[columnIndex]?.textContent.trim() : `Coluna ${columnIndex + 1}`;
            
            return `${rowId} ‚Üí ${columnName}`;
        }
        
        function getChangeIcon(changeType) {
            const icons = {
                [CHANGE_TYPES.CELL_EDIT]: '‚úèÔ∏è',
                [CHANGE_TYPES.ROW_ADD]: '‚ûï',
                [CHANGE_TYPES.ROW_DELETE]: '‚ûñ'
            };
            return icons[changeType] || 'üìù';
        }
        
        function showNotification(message, type = 'success') {
            const container = document.getElementById('notifications-container');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            container.appendChild(notification);
            
            // Anima entrada
            setTimeout(() => notification.classList.add('show'), 100);
            
            // Remove ap√≥s 4 segundos
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (container.contains(notification)) {
                        container.removeChild(notification);
                    }
                }, 300);
            }, 4000);
        }
        
        // === INTEGRA√á√ÉO COM SCRIPT EXISTENTE ===
        
        // Modifica a fun√ß√£o downloadModifiedFiles do script.js original
        // para usar nosso sistema de mudan√ßas
        window.originalDownloadModifiedFiles = window.downloadModifiedFiles;
        window.downloadModifiedFiles = openChangesReview;
    </script>
    
    <script>
        // Script adicional para lista.html (logout e sauda√ß√£o) - MANTIDO IGUAL
        document.addEventListener('DOMContentLoaded', () => {
            const loggedInUser = sessionStorage.getItem('ifclabsUser');
            const userGreetingElement = document.getElementById('user-greeting');
            const logoutButton = document.getElementById('logout-button');

            if (loggedInUser && userGreetingElement && logoutButton) {
                userGreetingElement.textContent = `Usu√°rio: ${loggedInUser}`;
                logoutButton.style.display = 'inline-block';
                logoutButton.onclick = () => {
                    sessionStorage.removeItem('ifclabsAuthToken');
                    sessionStorage.removeIte('ifclabsUser');
                    alert('Voc√™ foi desconectado.');
                    const repoNameSegment = '/IFCLABS';
                    let indexPath = 'index.html';
                    if (window.location.pathname.toLowerCase().startsWith(repoNameSegment.toLowerCase() + '/')) {
                        indexPath = `${repoNameSegment}/index.html`;
                    }
                    window.location.replace(indexPath);
                };
            } else if (userGreetingElement && logoutButton) { 
                 logoutButton.style.display = 'none';
                 userGreetingElement.textContent = '';
            }
        });
    </script>
</body>
</html>